@page "/Belgeler/Tum"
@model Lojistik.Pages.Belgeler.TumModel
@{
    ViewData["Title"] = "Tüm Belgeler";
}

<h2>Tüm Belgeler</h2>

<form method="get" class="row g-2 mb-3">
    <div class="col-sm-2">
        <label class="form-label">Plaka</label>
        <input name="Plaka" value="@Model.Plaka" class="form-control form-control-sm" />
    </div>
    <div class="col-sm-2">
        <label class="form-label">Belge Tipi</label>
        <input name="BelgeTipi" value="@Model.BelgeTipi" class="form-control form-control-sm" />
    </div>

    <!-- input type="date" için tarayıcı formatı yyyy-MM-dd olmalı -->
    <div class="col-sm-2">
        <label class="form-label">Başlangıç ≥</label>
        <input type="date" name="BaslangicMin" value="@(Model.BaslangicMin?.ToString("yyyy-MM-dd"))" class="form-control form-control-sm" />
    </div>
    <div class="col-sm-2">
        <label class="form-label">Başlangıç ≤</label>
        <input type="date" name="BaslangicMax" value="@(Model.BaslangicMax?.ToString("yyyy-MM-dd"))" class="form-control form-control-sm" />
    </div>
    <div class="col-sm-2">
        <label class="form-label">Bitiş ≥</label>
        <input type="date" name="BitisMin" value="@(Model.BitisMin?.ToString("yyyy-MM-dd"))" class="form-control form-control-sm" />
    </div>
    <div class="col-sm-2">
        <label class="form-label">Bitiş ≤</label>
        <input type="date" name="BitisMax" value="@(Model.BitisMax?.ToString("yyyy-MM-dd"))" class="form-control form-control-sm" />
    </div>

    <div class="col-sm-2">
        <label class="form-label">Sayfa Boyutu</label>
        <select name="PageSize" class="form-select form-select-sm" onchange="this.form.submit()">
            @{
                int[] sizes = new[] { 10, 20, 50, 100 };
                foreach (var s in sizes)
                {
                    <option value="@s" selected="@(Model.PageSize == s)">@s</option>
                }
            }
        </select>
        <input type="hidden" name="PageIndex" value="1" />
    </div>

    <div class="col-sm-2 d-flex align-items-end">
        <button type="submit" class="btn btn-primary btn-sm">Filtrele</button>
    </div>
</form>

<table class="table table-striped table-sm">
    <thead>
        <tr>
            <th>#</th>
            <th>Plaka</th>
            <th>Belge Tipi</th>
            <th>Belge No</th>
            <th>Firma</th>
            <th>Başlangıç</th>
            <th>Bitiş</th>
            <th>Tutar</th>
            <th>PB</th>
            <th>Notlar</th>
            <th style="width:260px;">İşlemler</th>
        </tr>
    </thead>
    <tbody>
        @{
            var sira = (Model.PageIndex - 1) * Model.PageSize + 1;
        }
        @foreach (var b in Model.Kayitlar)
        {
            // Görsel linkini düzgünleştir (~/ ile başlat)
            var yol = string.IsNullOrWhiteSpace(b.DosyaYolu)
            ? null
            : (b.DosyaYolu!.StartsWith("~")
            ? b.DosyaYolu
            : "~/" + b.DosyaYolu!.TrimStart('/'));

            <tr>
                <td>@sira</td>
                <td>@b.Arac?.Plaka</td>
                <td>@b.BelgeTipi</td>
                <td>@b.BelgeNo</td>
                <td>@b.Firma</td>

                <!-- dd-MM-yyyy ile GÖRÜNTÜLEME -->
                <td>@b.BaslangicTarihi.ToString("dd-MM-yyyy")</td>
                <td>@(b.BitisTarihi.HasValue? b.BitisTarihi.Value.ToString("dd-MM-yyyy") : "-")</td>

                <td>@(b.Tutar?.ToString("N2"))</td>
                <td>@b.ParaBirimi</td>
                <td class="text-truncate" style="max-width:280px;">@b.Notlar</td>

                <td>
                    <div class="btn-group" role="group">
                        <a class="btn btn-secondary btn-sm me-1" asp-page="/Araclar/Details" asp-route-id="@b.AracID">Araca Git</a>
                        <a class="btn btn-primary btn-sm me-1" asp-page="/Belgeler/Edit" asp-route-id="@b.BelgeID">Düzenle</a>
                        <a class="btn btn-danger btn-sm me-1" asp-page="/Belgeler/Delete" asp-route-id="@b.BelgeID">Sil</a>

                        @if (!string.IsNullOrWhiteSpace(yol))
                        {
                            <a class="btn btn-success btn-sm" href="@Url.Content(yol)" target="_blank" rel="noopener">Görsel</a>
                        }
                        else
                        {
                            <button type="button" class="btn btn-outline-secondary btn-sm" disabled>Görsel</button>
                        }
                    </div>
                </td>
            </tr>
            sira++;
        }
    </tbody>
</table>

@if (Model.TotalPages > 1)
{
    <nav>
        <ul class="pagination">
            <li class="page-item @(Model.PageIndex == 1 ? "disabled" : "")">
                <a class="page-link" asp-page="./Tum" asp-route-PageIndex="1"
                   asp-route-PageSize="@Model.PageSize"
                   asp-route-Plaka="@Model.Plaka" asp-route-BelgeTipi="@Model.BelgeTipi"
                   asp-route-BaslangicMin="@(Model.BaslangicMin?.ToString("yyyy-MM-dd"))"
                   asp-route-BaslangicMax="@(Model.BaslangicMax?.ToString("yyyy-MM-dd"))"
                   asp-route-BitisMin="@(Model.BitisMin?.ToString("yyyy-MM-dd"))"
                   asp-route-BitisMax="@(Model.BitisMax?.ToString("yyyy-MM-dd"))">İlk</a>
            </li>

            <li class="page-item @(Model.PageIndex == 1 ? "disabled" : "")">
                <a class="page-link" asp-page="./Tum" asp-route-PageIndex="@(Model.PageIndex - 1)"
                   asp-route-PageSize="@Model.PageSize"
                   asp-route-Plaka="@Model.Plaka" asp-route-BelgeTipi="@Model.BelgeTipi"
                   asp-route-BaslangicMin="@(Model.BaslangicMin?.ToString("yyyy-MM-dd"))"
                   asp-route-BaslangicMax="@(Model.BaslangicMax?.ToString("yyyy-MM-dd"))"
                   asp-route-BitisMin="@(Model.BitisMin?.ToString("yyyy-MM-dd"))"
                   asp-route-BitisMax="@(Model.BitisMax?.ToString("yyyy-MM-dd"))">Önceki</a>
            </li>

            @{
                int start = Math.Max(1, Model.PageIndex - 2);
                int end = Math.Min(Model.TotalPages, Model.PageIndex + 2);
                for (int i = start; i <= end; i++)
                {
                    <li class="page-item @(i == Model.PageIndex ? "active" : "")">
                        <a class="page-link" asp-page="./Tum" asp-route-PageIndex="@i"
                           asp-route-PageSize="@Model.PageSize"
                           asp-route-Plaka="@Model.Plaka" asp-route-BelgeTipi="@Model.BelgeTipi"
                           asp-route-BaslangicMin="@(Model.BaslangicMin?.ToString("yyyy-MM-dd"))"
                           asp-route-BaslangicMax="@(Model.BaslangicMax?.ToString("yyyy-MM-dd"))"
                           asp-route-BitisMin="@(Model.BitisMin?.ToString("yyyy-MM-dd"))"
                           asp-route-BitisMax="@(Model.BitisMax?.ToString("yyyy-MM-dd"))">@i</a>
                    </li>
                }
            }

            <li class="page-item @(Model.PageIndex == Model.TotalPages ? "disabled" : "")">
                <a class="page-link" asp-page="./Tum" asp-route-PageIndex="@(Model.PageIndex + 1)"
                   asp-route-PageSize="@Model.PageSize"
                   asp-route-Plaka="@Model.Plaka" asp-route-BelgeTipi="@Model.BelgeTipi"
                   asp-route-BaslangicMin="@(Model.BaslangicMin?.ToString("yyyy-MM-dd"))"
                   asp-route-BaslangicMax="@(Model.BaslangicMax?.ToString("yyyy-MM-dd"))"
                   asp-route-BitisMin="@(Model.BitisMin?.ToString("yyyy-MM-dd"))"
                   asp-route-BitisMax="@(Model.BitisMax?.ToString("yyyy-MM-dd"))">Sonraki</a>
            </li>
            <li class="page-item @(Model.PageIndex == Model.TotalPages ? "disabled" : "")">
                <a class="page-link" asp-page="./Tum" asp-route-PageIndex="@Model.TotalPages"
                   asp-route-PageSize="@Model.PageSize"
                   asp-route-Plaka="@Model.Plaka" asp-route-BelgeTipi="@Model.BelgeTipi"
                   asp-route-BaslangicMin="@(Model.BaslangicMin?.ToString("yyyy-MM-dd"))"
                   asp-route-BaslangicMax="@(Model.BaslangicMax?.ToString("yyyy-MM-dd"))"
                   asp-route-BitisMin="@(Model.BitisMin?.ToString("yyyy-MM-dd"))"
                   asp-route-BitisMax="@(Model.BitisMax?.ToString("yyyy-MM-dd"))">Son</a>
            </li>
        </ul>
    </nav>

    <div class="text-muted">
        Toplam @Model.TotalCount kayıt — Sayfa @Model.PageIndex / @Model.TotalPages
    </div>
}

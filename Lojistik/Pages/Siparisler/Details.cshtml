@page "{id:int}"
@model Lojistik.Pages.Siparisler.DetailsModel
@{
    ViewData["Title"] = "Sipariş Detayı";
    var s = Model.Data!;
}

@functions {
    // Sipariş durumu (değiştirmedik)
    string DurumMetni(byte d) => d switch
    {
        0 => "Taslak",
        1 => "Yüklendi",
        2 => "Araca Bağlandı",
        3 => "Tamamlandı",
        7 => "Sonlandırıldı",
        _ => "Bilinmiyor"
    };
    string DurumBadge(byte d) => d switch
    {
        0 => "secondary",
        1 => "info",
        2 => "primary",
        3 => "success",
        7 => "danger",
        _ => "dark"
    };

    // Sefer durumu (isteğine göre özel)
    string SeferDurumMetni(byte d) => d switch
    {
        0 => "Aktif",
        1 => "Kapalı",
        _ => "Bilinmiyor"
    };
    string SeferDurumBadge(byte d) => d switch
    {
        0 => "success", // Aktif
        1 => "danger",  // Kapalı
        _ => "secondary"
    };
}

<h2 class="mb-3">Sipariş Detayı</h2>

@if (TempData["StatusMessage"] is string msg && !string.IsNullOrWhiteSpace(msg))
{
    <div class="alert alert-success py-2 px-3">@msg</div>
}

<div class="mb-3 d-flex gap-2 flex-wrap">
    <a asp-page="./Edit" asp-route-id="@s.SiparisID" class="btn btn-warning">Düzenle</a>
    <a asp-page="./Delete" asp-route-id="@s.SiparisID" class="btn btn-danger">Sil</a>
    <a asp-page="./Index" class="btn btn-outline-secondary">Listeye Dön</a>

    @* Sonlandırılmış siparişte sevkiyat oluşturma tamamen pasif *@
    @if (s.Durum == 7)
    {
        <button class="btn btn-success" disabled>+ Sevkiyat Oluştur</button>
    }
    else if (Model.HasSevkiyat)
    {
        <button class="btn btn-success" disabled>Sevkiyat Oluştur</button>
    }
    else
    {
        <a asp-page="/Sevkiyatlar/Create" asp-route-siparisId="@s.SiparisID" class="btn btn-success">+ Sevkiyat Oluştur</a>
    }

    @* ======= CARI EK: Carileştir butonu (mevcut yapıyı bozmadan eklendi) ======= *@
    <button type="button" class="btn btn-primary ms-auto" data-bs-toggle="modal" data-bs-target="#carilestirModal">
        Cariye İşle
    </button>
    @* İleride .cs güncellemesinden sonra "Cari Kaydı Kaldır" koşullu olarak eklenecek *@
</div>

<div class="row g-3 mb-3">
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header fw-semibold">Genel</div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-4">Tarih</dt>
                    <dd class="col-sm-8">@s.SiparisTarihi.ToString("dd.MM.yyyy")</dd>

                    <dt class="col-sm-4">Yük Açıklaması</dt>
                    <dd class="col-sm-8 text-prewrap">@s.YukAciklamasi</dd>

                    <dt class="col-sm-4">Durum</dt>
                    <dd class="col-sm-8">
                        <span class="badge bg-@DurumBadge(s.Durum)">@DurumMetni(s.Durum)</span>
                    </dd>

                    <dt class="col-sm-4">Oluşturma</dt>
                    <dd class="col-sm-8">@s.CreatedAt.ToString("dd.MM.yyyy HH:mm")</dd>

                    <dt class="col-sm-4">Notlar</dt>
                    <dd class="col-sm-8 text-prewrap">@s.Notlar</dd>
                    <dt class="col-sm-4">Cari</dt>
                    <dd class="col-sm-8">
                        @if (Model.Cari.IsCarilestirildi)
                        {
                            <span class="badge bg-success me-2">Carileştirildi</span>
                            <span>@(Model.Cari.MusteriAdi ?? "—") (@Model.Cari.Taraf)</span>

                            <form method="post"
                                  asp-page-handler="CariCikart"
                                  asp-route-id="@s.SiparisID"
                                  class="d-inline me-2">
                                @Html.AntiForgeryToken()
                                <button type="submit"
                                        class="btn btn-danger btn-sm"
                                        style="position:relative; top:.25em;"
                                        onclick="return confirm('Bu siparişe ait cari hareket silinsin mi?');">
                                    Cariye İşlemeyi Kaldır
                                </button>
                            </form>
                        }
                        else
                        {
                            <span class="badge bg-secondary">Carileştirilmedi</span>
                        }
                    </dd>

                </dl>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header fw-semibold">Müşteriler & Fatura</div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-4">Gönderen</dt>
                    <dd class="col-sm-8">
                        @s.Gonderen
                        <div class="text-muted small">
                            @(string.Join(" / ", new[] { s.GonderenUlke, s.GonderenSehir }.Where(x => !string.IsNullOrWhiteSpace(x))))
                        </div>
                    </dd>

                    <dt class="col-sm-4">Alıcı</dt>
                    <dd class="col-sm-8">
                        @s.Alici
                        <div class="text-muted small">
                            @(string.Join(" / ", new[] { s.AliciUlke, s.AliciSehir }.Where(x => !string.IsNullOrWhiteSpace(x))))
                        </div>
                    </dd>

                    <dt class="col-sm-4">Ara Tedarikçi</dt>
                    <dd class="col-sm-8">@(!string.IsNullOrWhiteSpace(s.AraTedarikci) ? s.AraTedarikci : "—")</dd>

                    <dt class="col-sm-4">Fatura No</dt>
                    <dd class="col-sm-8">@(!string.IsNullOrWhiteSpace(s.FaturaNo) ? s.FaturaNo : "—")</dd>

                    <dt class="col-sm-4">Tutar</dt>
                    <dd class="col-sm-8">@((s.Tutar?.ToString("N2")) ?? "—") @s.ParaBirimi</dd>
                </dl>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm mb-3">
    <div class="card-header fw-semibold">İlişkili Sevkiyatlar</div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-sm table-hover mb-0 align-middle">
                <thead>
                    <tr>
                        @* ID kolonu gizli *@
                        <th>Dorse</th>
                        <th>Planlanan</th>
                        <th>Yükleme</th>
                        <th>Varış</th>
                        @* Durum kolonu kaldırıldı *@
                        <th class="text-end">İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Sevkiyatlar?.Count > 0)
                    {
                        foreach (var r in Model.Sevkiyatlar)
                        {
                            var finalized = s.Durum == 7;
                            <tr>
                                <td>@(string.IsNullOrWhiteSpace(r.DorsePlaka) ? "—" : r.DorsePlaka)</td>
                                <td>@r.PlanlananYuklemeTarihi?.ToString("dd.MM.yyyy")</td>
                                <td>@r.YuklemeTarihi?.ToString("dd.MM.yyyy")</td>
                                <td>@r.VarisTarihi?.ToString("dd.MM.yyyy")</td>
                                <td class="text-end">
                                    <div class="d-inline-flex flex-wrap gap-1">
                                        @if (s.Durum == 7)  // finalized
                                        {
                                            <a class="btn btn-primary btn-sm disabled" tabindex="-1" aria-disabled="true">Aç</a>
                                            <a class="btn btn-warning btn-sm disabled" tabindex="-1" aria-disabled="true">Düzenle</a>
                                            <button type="button" class="btn btn-danger btn-sm" disabled>Sil</button>
                                        }
                                        else
                                        {
                                            <a asp-page="/Sevkiyatlar/Details" asp-route-id="@r.SevkiyatID" class="btn btn-primary btn-sm">Aç</a>
                                            <a asp-page="/Sevkiyatlar/Edit" asp-route-id="@r.SevkiyatID" class="btn btn-warning btn-sm">Düzenle</a>

                                            <form method="post"
                                                  asp-page="/Sevkiyatlar/Delete"
                                                  class="d-inline"
                                                  onsubmit="return confirm('Bu sevkiyatı silmek istediğinize emin misiniz?');">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="id" value="@r.SevkiyatID" />
                                                <input type="hidden" name="siparisId" value="@s.SiparisID" />
                                                <button type="submit" class="btn btn-danger btn-sm">Sil</button>
                                            </form>
                                        }
                                    </div>
                                </td>

                            </tr>
                        }
                    }
                    else
                    {
                        <tr><td colspan="5" class="text-center text-muted">Sevkiyat yok.</td></tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-header fw-semibold">İlişkili Seferler</div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-sm table-hover mb-0 align-middle">
                <thead>
                    <tr>
                        @* ID kolonu gizli *@
                        <th>Kod</th>
                        <th>Çıkış</th>
                        <th>Çekici</th>
                        @* Dorse kolonu kaldırıldı *@
                        <th>Sürücü</th>
                        <th>Durum</th>
                        <th class="text-end">İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Seferler?.Count > 0)
                    {
                        foreach (var r in Model.Seferler)
                        {
                            <tr>
                                <td>@(string.IsNullOrWhiteSpace(r.SeferKodu) ? $"SF-{r.SeferID}" : r.SeferKodu)</td>
                                <td>@r.CikisTarihi?.ToString("dd.MM.yyyy")</td>
                                <td>@r.CekiciPlaka</td>
                                @* Dorse hücresi kaldırıldı *@
                                <td>@r.SurucuAdi</td>
                                <td>
                                    <span class="badge bg-@SeferDurumBadge(r.Durum)">@SeferDurumMetni(r.Durum)</span>
                                </td>
                                <td class="text-end">
                                    <div class="d-inline-flex flex-wrap gap-1">
                                        <a asp-page="/Seferler/Details" asp-route-id="@r.SeferID" class="btn btn-primary btn-sm">Aç</a>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr><td colspan="6" class="text-center text-muted">Sefer yok.</td></tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@* ======= CARI EK: Carileştir Modalı (mevcut yapıyı bozmadan eklendi) ======= *@
<div class="modal fade" id="carilestirModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form method="post" asp-page-handler="Carilestir" class="modal-content">
            @Html.AntiForgeryToken()
            <div class="modal-header">
                <h5 class="modal-title">Siparişi Cariye İşle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" name="id" value="@s.SiparisID" />

                <div class="mb-2">
                    <label class="form-label">Para Birimi</label>
                    <input class="form-control" name="ParaBirimi" value="@s.ParaBirimi" readonly />
                </div>

                <div class="mb-2">
                    <label class="form-label d-block">Cari Tarafı</label>

                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="Hedef" id="hedefAlici" value="Alici" checked />
                        <label class="form-check-label" for="hedefAlici">
                            Alıcı (@(s.Alici ?? "—"))
                        </label>
                    </div>

                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="Hedef" id="hedefGonderen" value="Gonderen" />
                        <label class="form-check-label" for="hedefGonderen">
                            Gönderen (@(s.Gonderen ?? "—"))
                        </label>
                    </div>

                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="Hedef" id="hedefAra" value="Ara"
                               @(s.AraTedarikciMusteriID == null ? "disabled" : "") />
                        <label class="form-check-label" for="hedefAra">
                            Ara Tedarikçi (@(s.AraTedarikci ?? "—")) @(s.AraTedarikciMusteriID == null ? "— yok —" : "")
                        </label>
                    </div>
                </div>

                <div class="mb-2">
                    <label class="form-label">Açıklama</label>
                    <input class="form-control" name="Aciklama" maxlength="300" />
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Vazgeç</button>
                <button class="btn btn-primary" type="submit">Carileştir</button>
            </div>
        </form>
    </div>
</div>

